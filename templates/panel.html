<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CRT Ambience</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            body {
                background-color: #1c1c1c;
                font-family: "VT323", monospace;
            }
        </style>
        <link
            href="https://fonts.googleapis.com/css2?family=VT323&display=swap"
            rel="stylesheet"
        />
    </head>
    <body class="bg-gray-900 text-purple-500">
        <div class="max-w-lg mx-auto px-4 py-8">
            <h1 class="text-4xl font-bold mb-8 text-center">crt</h1>
            <form
                id="uploadForm"
                class="mb-8 border-2 border-purple-500 p-4 rounded-md"
            >
                <div class="mb-4">
                    <div class="relative">
                        <input type="file" id="fileInput" class="hidden" />
                        <input
                            spellcheck="false"
                            type="text"
                            id="fileNameInput"
                            class="w-full bg-black text-purple-500 px-4 py-2 pr-10 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="file"
                        />
                        <button
                            type="button"
                            id="browseButton"
                            class="absolute top-0 right-0 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-black rounded-r-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                        >
                            choose
                        </button>
                    </div>
                </div>
                <button
                    type="submit"
                    class="w-full bg-purple-500 hover:bg-purple-600 text-black py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                >
                    upload
                </button>
            </form>

            <div class="mb-8 border-2 border-purple-500 p-4 rounded-md">
                <h2 class="text-2xl font-bold mb-4">video opts</h2>
                <div class="flex flex-row gap-2">
                    <label class="flex items-center">
                        <span class="mr-2">gain</span>
                        <input
                            type="number"
                            id="gain"
                            class="form-input w-20 px-2 py-1 bg-black text-purple-500 rounded-md focus:outline-none focus:ring-purple-500"
                            value="0"
                        />
                    </label>
                    <label class="flex items-center w-full">
                        <span class="mr-2">visualizer</span>
                        <select
                            id="visualizer"
                            class="w-full form-select block w-full px-3 py-1.5 text-base font-normal bg-black text-purple-500 bg-clip-padding bg-no-repeat rounded transition ease-in-out m-0 focus:outline-none focus:ring-purple-500"
                        >
                            <option value="none" selected>None</option>
                            <option value="scope">Scope</option>
                            <option value="spectrum">Spectrum</option>
                            <option value="spectrometer">Spectrometer</option>
                            <option value="vuMeter">VU Meter</option>
                        </select>
                    </label>
                </div>
            </div>

            <div class="mb-8 border-2 border-purple-500 p-4 rounded-md">
                <h2 class="text-2xl font-bold mb-4">controls</h2>
                <div class="flex flex-row gap-2">
                    <button
                        id="stopButton"
                        class="w-full bg-red-500 hover:bg-red-600 text-black py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                    >
                        stop
                    </button>

                    <button
                        id="randomButton"
                        class="w-full bg-purple-500 hover:bg-purple-600 text-black py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                    >
                        random video
                    </button>
                </div>
            </div>

            <div class="mt-8 border-2 border-purple-500 p-4 rounded-md">
                <h2 class="text-2xl font-bold mb-4">videos</h2>
                <ul
                    id="videoList"
                    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"
                ></ul>
            </div>
        </div>

        <script>
            // i love you jquery
            const $ = (selector) => document.querySelector(selector);

            const fileInput = $("#fileInput");
            const fileNameInput = $("#fileNameInput");
            const videoList = $("#videoList");

            function getSettings() {
                const visualizer = $("#visualizer").value;

                return {
                    gain: parseFloat($("#gain").value),
                    visualizer: visualizer === "none" ? undefined : visualizer,
                };
            }

            async function fetchVideos() {
                const response = await fetch("/videos");
                if (!response.ok) {
                    return console.error("Failed to fetch videos", response);
                }

                const videos = await response.json();
                videoList.innerHTML = videos
                    .map(
                        (video) => `
                            <li class="bg-black border-2 border-purple-500 rounded-md shadow overflow-hidden">
                              <div class="relative">
                                <img src="/thumbs/${video.name_without_ext}.jpg" alt="${video.name} thumbnail" class="w-full h-48 object-cover">
                                <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent">
                                  <span class="block text-purple-500 font-bold truncate">${video.name}</span>
                                </div>
                              </div>
                              <div class="flex divide-x-2 divide-purple-500">
                                <button class="video-button w-1/2 py-2 bg-green-500 hover:bg-green-600 text-black text-sm uppercase tracking-wider focus:outline-none focus:ring-2 focus:ring-green-500" data-video="${video.name}">Play</button>
                                <button class="delete-button w-1/2 py-2 bg-red-500 hover:bg-red-600 text-black text-sm uppercase tracking-wider focus:outline-none focus:ring-2 focus:ring-red-500" data-video="${video.name}">Delete</button>
                              </div>
                            </li>
                          `,
                    )
                    .join("");
            }

            async function playVideo(videoName) {
                const response = await fetch("/videos", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        file_name: videoName,
                        ...getSettings(),
                    }),
                });

                if (response.ok) {
                    console.log("Video switched", response);
                } else {
                    console.error("Failed to switch video", response);
                }
            }

            async function stopVideo() {
                const response = await fetch("/stop");
                if (response.ok) {
                    console.log("Video stopped", response);
                } else {
                    console.error("Failed to stop video", response);
                }
            }

            async function uploadVideo(file, fileName) {
                const response = await fetch(`/videos?file_name=${fileName}`, {
                    method: "POST",
                    body: file,
                });

                if (response.ok) {
                    console.log("Upload successful", response);
                    fetchVideos();
                } else {
                    console.error("Failed to upload video", response);
                }
            }

            async function deleteVideo(videoName) {
                const response = await fetch(`/videos`, {
                    method: "DELETE",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ file_name: videoName }),
                });

                if (response.ok) {
                    console.log("Video deleted", response);
                    fetchVideos();
                } else {
                    console.error("Failed to delete video", response);
                }
            }

            $("#browseButton").addEventListener("click", () =>
                fileInput.click(),
            );

            $("#uploadForm").addEventListener("submit", async (e) => {
                e.preventDefault();

                const file = fileInput.files[0];
                const fileName = fileNameInput.value;

                if (file) {
                    uploadVideo(file, fileName);
                }
            });

            fileInput.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (file) {
                    fileNameInput.value = file.name;
                }
            });

            videoList.addEventListener("click", (e) => {
                const { classList } = e.target;
                const { video: videoName } = e.target.dataset;

                if (!videoName) {
                    return;
                }

                if (classList.contains("video-button")) {
                    playVideo(videoName);
                }

                if (classList.contains("delete-button")) {
                    deleteVideo(videoName);
                }
            });

            $("#randomButton").addEventListener("click", async () => {
                const response = await fetch("/videos");
                if (!response.ok) {
                    return console.error("Failed to fetch videos", response);
                }

                const videos = await response.json();
                const randomVideo =
                    videos[Math.floor(Math.random() * videos.length)];

                playVideo(randomVideo.name);
            });

            $("#stopButton").addEventListener("click", stopVideo);

            fetchVideos();
        </script>
    </body>
</html>
