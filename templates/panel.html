<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CRT Ambience</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            /* Dark mode styles */
            body {
                background-color: #1a202c;
                color: #fff;
            }
            input,
            select,
            button {
                background-color: #2d3748;
                color: #fff;
                border-color: #4a5568;
            }
            input:focus,
            select:focus,
            button:focus {
                outline: none;
                ring: 2px solid #63b3ed;
            }
            .bg-white {
                background-color: #2d3748;
            }
            .text-gray-800 {
                color: #fff;
            }
            .hover\:bg-blue-600:hover {
                background-color: #3182ce;
            }
            .hover\:bg-red-600:hover {
                background-color: #e53e3e;
            }
        </style>
    </head>
    <body>
        <div class="max-w-lg mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold mb-8 text-center">
                CRT Ambience - File Upload
            </h1>
            <form id="uploadForm" class="mb-8">
                <div class="mb-4">
                    <label for="fileInput" class="block mb-2 font-bold"
                        >Select Video File</label
                    >
                    <div class="relative">
                        <input type="file" id="fileInput" class="hidden" />
                        <input
                            spellcheck="false"
                            type="text"
                            id="fileNameInput"
                            class="w-full px-4 py-2 pr-10 rounded-md focus:ring-2 focus:ring-blue-500"
                            placeholder="Choose file..."
                        />
                        <button
                            type="button"
                            id="browseButton"
                            class="absolute top-0 right-0 px-4 py-2 bg-blue-500 text-white rounded-r-md focus:ring-2 focus:ring-blue-500"
                        >
                            Browse
                        </button>
                    </div>
                </div>
                <button
                    type="submit"
                    class="w-full bg-blue-500 text-white py-2 px-4 rounded-md focus:ring-2 focus:ring-blue-500"
                >
                    Upload
                </button>
            </form>

            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Available Videos</h2>
                <ul
                    id="videoList"
                    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"
                ></ul>
            </div>

            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Video Options</h2>
                <div
                    class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4"
                >
                    <label class="flex items-center">
                        <input
                            type="number"
                            id="gain"
                            class="form-input w-20 px-2 py-1 rounded-md focus:ring-blue-500"
                            value="0"
                        />
                        <span class="ml-2">Gain</span>
                    </label>
                    <label class="flex items-center">
                        <select
                            id="visualizer"
                            class="form-select block w-full px-3 py-1.5 text-base font-normal bg-clip-padding bg-no-repeat rounded transition ease-in-out m-0 focus:ring-blue-500"
                        >
                            <option value="none" selected>None</option>
                            <option value="scope">Scope</option>
                            <option value="spectrum">Spectrum</option>
                            <option value="spectrometer">Spectrometer</option>
                            <option value="vuMeter">VU Meter</option>
                        </select>
                        <span class="ml-2">Visualizer</span>
                    </label>
                </div>
            </div>

            <div>
                <h2 class="text-2xl font-bold mb-4">Controls</h2>
                <button
                    id="stopButton"
                    class="w-full bg-red-500 text-white py-2 px-4 rounded-md focus:ring-2 focus:ring-red-500"
                >
                    Stop Video
                </button>
            </div>
        </div>

        <script>
            // i love you jquery
            const $ = (selector) => document.querySelector(selector);

            const fileInput = $("#fileInput");
            const fileNameInput = $("#fileNameInput");
            const videoList = $("#videoList");

            function getSettings() {
                const visualizer = $("#visualizer").value;

                return {
                    gain: parseFloat($("#gain").value),
                    visualizer: visualizer === "none" ? undefined : visualizer,
                };
            }

            async function fetchVideos() {
                const response = await fetch("/videos");
                if (!response.ok) {
                    return console.error("Failed to fetch videos", response);
                }

                const videos = await response.json();
                videoList.innerHTML = videos
                    .map(
                        (video) => `
                    <li class="bg-white rounded-md shadow overflow-hidden">
                      <div class="relative">
                        <img src="/thumbs/${video.name_without_ext}.jpg" alt="${video.name} thumbnail" class="w-full h-48 object-cover">
                        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent">
                          <span class="block text-white font-bold truncate">${video.name}</span>
                        </div>
                      </div>
                      <div class="flex divide-x divide-gray-200">
                        <button class="video-button w-1/2 py-2 bg-blue-500 text-white text-sm uppercase tracking-wider focus:ring-2 focus:ring-blue-500" data-video="${video.name}">Play</button>
                        <button class="delete-button w-1/2 py-2 bg-red-500 text-white text-sm uppercase tracking-wider focus:ring-2 focus:ring-red-500" data-video="${video.name}">Delete</button>
                      </div>
                    </li>
                  `,
                    )
                    .join("");
            }

            async function playVideo(videoName) {
                const response = await fetch("/videos", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        file_name: videoName,
                        ...getSettings(),
                    }),
                });

                if (response.ok) {
                    console.log("Video switched", response);
                } else {
                    console.error("Failed to switch video", response);
                }
            }

            async function stopVideo() {
                const response = await fetch("/stop");
                if (response.ok) {
                    console.log("Video stopped", response);
                } else {
                    console.error("Failed to stop video", response);
                }
            }

            async function uploadVideo(file, fileName) {
                const response = await fetch(`/videos?file_name=${fileName}`, {
                    method: "POST",
                    body: file,
                });

                if (response.ok) {
                    console.log("Upload successful", response);
                    fetchVideos();
                } else {
                    console.error("Failed to upload video", response);
                }
            }

            async function deleteVideo(videoName) {
                const response = await fetch(`/videos`, {
                    method: "DELETE",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ file_name: videoName }),
                });

                if (response.ok) {
                    console.log("Video deleted", response);
                    fetchVideos();
                } else {
                    console.error("Failed to delete video", response);
                }
            }

            $("#browseButton").addEventListener("click", () =>
                fileInput.click(),
            );

            $("#uploadForm").addEventListener("submit", async (e) => {
                e.preventDefault();

                const file = fileInput.files[0];
                const fileName = fileNameInput.value;

                if (file) {
                    uploadVideo(file, fileName);
                }
            });

            fileInput.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (file) {
                    fileNameInput.value = file.name;
                }
            });

            videoList.addEventListener("click", (e) => {
                const { classList } = e.target;
                const { video: videoName } = e.target.dataset;

                if (!videoName) {
                    return;
                }

                if (classList.contains("video-button")) {
                    playVideo(videoName);
                }

                if (classList.contains("delete-button")) {
                    deleteVideo(videoName);
                }
            });

            $("#stopButton").addEventListener("click", stopVideo);

            fetchVideos();
        </script>
    </body>
</html>
